name: ðŸ›¡ï¸ ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø£Ù…Ø§Ù†

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # ÙØ­Øµ ÙŠÙˆÙ…ÙŠ ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 3:00 ØµØ¨Ø§Ø­Ø§Ù‹ UTC
    - cron: '0 3 * * *'

jobs:
  quality-check:
    name: ðŸ” ÙØ­Øµ Ø´Ø§Ù…Ù„ Ù„Ù„Ø¬ÙˆØ¯Ø©
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: ðŸ”§ TypeScript Check
      run: npx tsc --noEmit --skipLibCheck
      
    - name: ðŸ§¹ ESLint Check
      run: npx eslint . --ext .ts,.tsx --format json --output-file eslint-report.json
      continue-on-error: true
      
    - name: ðŸ›¡ï¸ Custom Quality Check
      run: node scripts/quality-assurance/code-integrity-checker.js
      
    - name: ðŸ“Š Upload Quality Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: quality-reports-${{ matrix.node-version }}
        path: |
          code-integrity-report.json
          eslint-report.json
          
  security-check:
    name: ðŸ”’ ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: ðŸ” Security Audit
      run: npm audit --audit-level high
      continue-on-error: true
      
    - name: ðŸ›¡ï¸ Dependency Check
      run: |
        npx depcheck --ignores="@types/*,eslint-*" 2>&1 | tee dependency-report.txt
      continue-on-error: true
      
    - name: ðŸ“Š Upload Security Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          dependency-report.txt
          
  build-test:
    name: ðŸ—ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ù†Ø§Ø¡
    runs-on: ubuntu-latest
    needs: [quality-check]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: ðŸ—ï¸ Build Project
      run: npm run build
      env:
        NODE_ENV: production
        
    - name: ðŸ“Š Build Size Check
      run: |
        du -sh .next/ | tee build-size.txt
        echo "Build completed successfully" >> build-size.txt
        
    - name: ðŸ“Š Upload Build Reports
      uses: actions/upload-artifact@v3
      with:
        name: build-reports
        path: build-size.txt

  notify-on-failure:
    name: ðŸ“¢ Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
    runs-on: ubuntu-latest
    needs: [quality-check, security-check, build-test]
    if: failure()
    
    steps:
    - name: ðŸ“§ Send Notification
      run: |
        echo "ðŸš¨ ÙØ´Ù„ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø£Ùˆ Ø§Ù„Ø¨Ù†Ø§Ø¡!"
        echo "Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ${{ github.repository }}"
        echo "Ø§Ù„ÙØ±Ø¹: ${{ github.ref }}"
        echo "Ø§Ù„ÙƒÙˆÙ…ÙŠØª: ${{ github.sha }}"
        echo "ØªØ§Ø±ÙŠØ®: $(date)"
        
  generate-quality-report:
    name: ðŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    runs-on: ubuntu-latest
    needs: [quality-check, security-check, build-test]
    if: always()
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ Download all reports
      uses: actions/download-artifact@v3
      
    - name: ðŸ“Š Generate Summary Report
      run: |
        echo "# ðŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø´Ø§Ù…Ù„" > QUALITY_REPORT.md
        echo "" >> QUALITY_REPORT.md
        echo "**Ø§Ù„ØªØ§Ø±ÙŠØ®**: $(date)" >> QUALITY_REPORT.md
        echo "**Ø§Ù„ÙØ±Ø¹**: ${{ github.ref }}" >> QUALITY_REPORT.md
        echo "**Ø§Ù„ÙƒÙˆÙ…ÙŠØª**: ${{ github.sha }}" >> QUALITY_REPORT.md
        echo "" >> QUALITY_REPORT.md
        
        echo "## ðŸ” Ù†ØªØ§Ø¦Ø¬ ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø©" >> QUALITY_REPORT.md
        if [ -f "quality-reports-20.x/code-integrity-report.json" ]; then
          echo "âœ… ØªÙ… Ø¥Ù†Ø¬Ø§Ø² ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ø§Ù„ÙƒÙˆØ¯" >> QUALITY_REPORT.md
        else
          echo "âŒ ÙØ´Ù„ ÙÙŠ ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ø§Ù„ÙƒÙˆØ¯" >> QUALITY_REPORT.md
        fi
        
        echo "" >> QUALITY_REPORT.md
        echo "## ðŸ”’ Ù†ØªØ§Ø¦Ø¬ ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†" >> QUALITY_REPORT.md
        if [ -f "security-reports/dependency-report.txt" ]; then
          echo "âœ… ØªÙ… Ø¥Ù†Ø¬Ø§Ø² ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†" >> QUALITY_REPORT.md
        else
          echo "âŒ ÙØ´Ù„ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†" >> QUALITY_REPORT.md
        fi
        
        echo "" >> QUALITY_REPORT.md
        echo "## ðŸ—ï¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ù†Ø§Ø¡" >> QUALITY_REPORT.md
        if [ -f "build-reports/build-size.txt" ]; then
          echo "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­" >> QUALITY_REPORT.md
          echo "" >> QUALITY_REPORT.md
          echo "### Ø­Ø¬Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡:" >> QUALITY_REPORT.md
          echo "\`\`\`" >> QUALITY_REPORT.md
          cat build-reports/build-size.txt >> QUALITY_REPORT.md
          echo "\`\`\`" >> QUALITY_REPORT.md
        else
          echo "âŒ ÙØ´Ù„ ÙÙŠ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹" >> QUALITY_REPORT.md
        fi
        
    - name: ðŸ“¤ Upload Final Report
      uses: actions/upload-artifact@v3
      with:
        name: final-quality-report
        path: QUALITY_REPORT.md
