;; PgBouncer Configuration File
;; تكوين PgBouncer لتحسين إدارة اتصالات PostgreSQL

[databases]
;; تعريف قواعد البيانات
;; Format: dbname = connection_string
sooq_mazad = host=localhost port=5432 dbname=sooq_mazad user=postgres password=YOUR_PASSWORD

;; يمكن إضافة قواعد بيانات أخرى
;; test_db = host=localhost port=5432 dbname=test_db

[pgbouncer]
;;; Administrative settings

;; مكان الاستماع - يُفضل localhost فقط للأمان
listen_addr = 127.0.0.1

;; منفذ PgBouncer (سيستمع على هذا المنفذ بدلاً من 5432)
listen_port = 6432

;; نوع الاتصالات Unix socket (اختياري)
;unix_socket_dir = /tmp
;unix_socket_mode = 0777

;;; Authentication settings

;; ملف المصادقة (يحتوي على أسماء المستخدمين وكلمات المرور)
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

;; قائمة المستخدمين المسموح لهم بالاتصال
;; يمكن استخدام all للسماح للجميع
;admin_users = postgres

;;; Pooling settings - أهم الإعدادات للأداء

;; نمط التجميع:
;; - session: اتصال واحد لكل جلسة (الأبطأ، الأكثر أماناً)
;; - transaction: إعادة استخدام الاتصال بعد كل معاملة (موصى به)
;; - statement: إعادة استخدام بعد كل استعلام (الأسرع، الأقل أماناً)
pool_mode = transaction

;; الحد الأقصى لاتصالات العميل
max_client_conn = 100

;; الحد الأقصى لاتصالات قاعدة البيانات لكل قاعدة بيانات
default_pool_size = 25

;; الحد الأدنى لاتصالات Pool (اتصالات دائمة)
min_pool_size = 5

;; عدد اتصالات الاحتياط
reserve_pool_size = 5

;; وقت الانتظار الأقصى للحصول على اتصال (ثانية)
reserve_pool_timeout = 3

;; الحد الأقصى لعمر الاتصال (ثانية) - إعادة إنشاء بعد ساعة
max_db_connections = 50

;; إعادة استخدام الاتصالات بعد X ثانية (ساعة واحدة)
server_lifetime = 3600

;; Idle timeout - إغلاق الاتصالات الخاملة بعد 10 دقائق
server_idle_timeout = 600

;;; Logging

;; مستوى السجلات: ERROR, WARNING, INFO, DEBUG
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

;; ملف السجل
;logfile = /var/log/pgbouncer/pgbouncer.log
;pidfile = /var/run/pgbouncer/pgbouncer.pid

;;; Connection sanity checks, timeouts

;; وقت انتظار الاستعلام (ثانية) - 0 = بدون حد
;query_timeout = 0

;; وقت انتظار المعاملة (ثانية)
;query_wait_timeout = 120

;; وقت انتظار الاتصال بالخادم
;server_connect_timeout = 15

;; فحص صحة الاتصال
;server_check_query = select 1
;server_check_delay = 30

;;; TLS settings (اختياري - للأمان)

;client_tls_sslmode = disable
;server_tls_sslmode = disable

;;; Dangerous timeouts

;; إغلاق الاتصالات التي تجاوزت وقت المعاملة
;server_reset_query = DISCARD ALL
;server_reset_query_always = 0

;;; Console access control

;; قاعدة بيانات إدارية افتراضية
;admin_users = postgres
;stats_users = stats, postgres

;;; Performance tuning

;; حجم Buffer للإرسال والاستقبال
;pkt_buf = 4096
;sbuf_loopcnt = 5

;; TCP settings
;tcp_defer_accept = 0
;tcp_socket_buffer = 0
;tcp_keepalive = 1
;tcp_keepcnt = 0
;tcp_keepidle = 0
;tcp_keepintvl = 0

;;; Memory limits

;; الحد الأقصى للذاكرة المستخدمة (غير مفعّل بشكل افتراضي)
;max_packet_size = 2147483647
