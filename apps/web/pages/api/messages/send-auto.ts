import { NextApiRequest, NextApiResponse } from 'next';
import prisma from '../../../lib/prisma';

/**
 * API Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© (Ù…Ø«Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹)
 * POST /api/messages/send-auto
 */
export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'POST') {
    return res.status(405).json({ 
      success: false, 
      message: 'Method not allowed' 
    });
  }

  try {
    const { recipientId, message, type, auctionId, metadata } = req.body;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    if (!recipientId || !message) {
      return res.status(400).json({
        success: false,
        message: 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø© - ÙŠØ¬Ø¨ ØªÙˆÙÙŠØ± recipientId Ùˆ message'
      });
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…
    const recipient = await prisma.users.findUnique({
      where: { id: String(recipientId) },
      select: { id: true, name: true, email: true }
    });

    if (!recipient) {
      return res.status(404).json({
        success: false,
        message: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'
      });
    }

    // ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø±
    // ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø«Ø§Ù„ Ø³Ù†Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒØ¥Ø´Ø¹Ø§Ø±
    const notification = await prisma.notifications.create({
      data: {
        id: `notif_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        userId: String(recipientId),
        type: type || 'SALE_CONFIRMED',
        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹',
        message: message,
        auctionId: auctionId ? String(auctionId) : null,
        metadata: metadata || null,
        isRead: false,
      }
    });

    console.log(`âœ… [Auto Message] ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${recipientId}`);

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    if (recipient.email) {
      try {
        // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù‡Ù†Ø§
        console.log(`ğŸ“§ [Auto Message] ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¥Ù„Ù‰: ${recipient.email}`);
      } catch (emailError) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:', emailError);
        // Ù„Ø§ Ù†ÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
      }
    }

    return res.status(200).json({
      success: true,
      message: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­',
      data: {
        notificationId: notification.id,
        recipientId: recipient.id,
        recipientName: recipient.name,
      }
    });

  } catch (error) {
    console.error('[Auto Message Error]:', error);
    return res.status(500).json({
      success: false,
      message: 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©',
      error: error instanceof Error ? error.message : 'Unknown error'
    });
  }
}
