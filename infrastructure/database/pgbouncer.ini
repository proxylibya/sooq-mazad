;; PgBouncer Configuration for High Traffic
;; إعدادات PgBouncer للحركة العالية

[databases]
;; قاعدة البيانات الرئيسية
sooq_mazad = host=postgres port=5432 dbname=sooq_mazad

;; Read Replica (للقراءة فقط)
sooq_mazad_readonly = host=postgres-replica port=5432 dbname=sooq_mazad

[pgbouncer]
;; =====================================
;; إعدادات الاستماع
;; =====================================
listen_addr = 0.0.0.0
listen_port = 6432
unix_socket_dir = /var/run/postgresql

;; =====================================
;; إعدادات المصادقة
;; =====================================
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

;; =====================================
;; إعدادات Pool
;; =====================================
;; وضع Pool - transaction هو الأفضل للأداء
pool_mode = transaction

;; الحد الأقصى للاتصالات من العملاء
max_client_conn = 5000

;; الحد الافتراضي للاتصالات لكل pool
default_pool_size = 100

;; الحد الأدنى للاتصالات المحجوزة
min_pool_size = 10

;; الحد الأقصى للاتصالات المحجوزة لكل قاعدة بيانات
reserve_pool_size = 25

;; مهلة انتظار pool
reserve_pool_timeout = 3

;; الحد الأقصى للاتصالات لكل قاعدة بيانات
max_db_connections = 200

;; الحد الأقصى للاتصالات لكل مستخدم
max_user_connections = 100

;; =====================================
;; إعدادات المهلات
;; =====================================
;; مهلة الاستعلام (5 دقائق)
query_timeout = 300

;; مهلة الخمول للعميل (30 دقيقة)
client_idle_timeout = 1800

;; مهلة الخمول للخادم (10 دقائق)
server_idle_timeout = 600

;; مهلة الاتصال
server_connect_timeout = 15

;; مهلة تسجيل الدخول
server_login_retry = 15

;; =====================================
;; إعدادات إضافية
;; =====================================
;; تفعيل إعادة استخدام الاتصال
server_reset_query = DISCARD ALL

;; تفعيل prepared statements
server_check_query = SELECT 1

;; الفاصل الزمني لفحص الخادم
server_check_delay = 30

;; تجاهل طلبات startup في transaction mode
ignore_startup_parameters = extra_float_digits

;; =====================================
;; إعدادات الأمان
;; =====================================
;; تفعيل SSL
;client_tls_sslmode = prefer
;client_tls_key_file = /etc/pgbouncer/server.key
;client_tls_cert_file = /etc/pgbouncer/server.crt

;; =====================================
;; إعدادات السجلات
;; =====================================
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

;; مستوى التسجيل
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

;; =====================================
;; إعدادات الإدارة
;; =====================================
admin_users = postgres,admin
stats_users = stats,monitoring

;; =====================================
;; إعدادات TCP
;; =====================================
tcp_keepalive = 1
tcp_keepidle = 60
tcp_keepintvl = 30
tcp_keepcnt = 3
